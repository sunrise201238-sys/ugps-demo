<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UGPS</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  />

  <style>
    :root{
      --warm-1:#FFE08A;
      --warm-2:#FF9F43;
      --warm-3:#FF6B6B;
    }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;margin:24px}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .badge{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer}
    .badge.active{background:#eef;border-color:#99f}
    .card{border:1px solid #eee;border-radius:12px;padding:16px}
    small{color:#777}

    .legend-bar{
      height:8px;border-radius:999px;width:100%;
      background:linear-gradient(90deg,var(--warm-1) 0%,var(--warm-2) 55%,var(--warm-3) 100%);
    }

    /* 點位：彩色實心 + 黑外圈(2px) + 白外圈(2px)，顏色大、邊緣薄 */
    .ugps-dot{
      width:20px;height:20px;border-radius:50%;
      background:var(--fill,#FF9F43);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 4px #fff;
      transform:translate(-10px,-10px);
    }

    /* map 必須有固定高度 */
    #map{
      height:560px;
      min-height:360px;
      border-radius:12px;
      overflow:hidden;
      background:#f7f7f7;
    }
  </style>
</head>
<body>
  <div class="row">
    <h1 id="app.title">UGPS</h1>
    <div style="margin-left:auto">
      <button id="btn-zhtw" class="badge">zhtw</button>
      <button id="btn-enus" class="badge">enus</button>
    </div>
  </div>

  <div class="row">
    <a id="nav.home" href="#">首頁</a>
    <a id="nav.map" href="#" style="margin-left:12px">地圖</a>
    <a id="nav.export" href="#" style="margin-left:12px">匯出</a>
  </div>

  <div class="card" aria-label="legend">
    <b id="legend.title">Legend</b>
    <div class="row" style="margin-top:8px">
      <small id="map.legend.low">低</small>
      <div class="legend-bar" title="Low → High"></div>
      <small id="map.legend.high">高</small>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600"><span id="map.title">地圖</span> · <small>UGPS 分數點位</small></div>
      <div>
        <button id="btn-points" class="badge active">點位</button>
        <button id="btn-heat"   class="badge">熱度圖</button>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <b id="top3.title">優先格網 Top-3</b>
    <ol id="top3"></ol>
  </div>

  <div style="position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 12px;font-size:12px;color:#555">
    <b id="meta.dataSource">資料來源</b>：OSM / Gov Open Data　|　
    <b id="meta.version">版本</b>：v0.0.1
  </div>

  <!-- Leaflet & heat scripts DEFERRED so HTML exists first -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStb6ZkM00syQFhGZ8ZQ8v4v1jz7G8Q1rC2c=" crossorigin=""></script>
  <script defer src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script defer>
  document.addEventListener('DOMContentLoaded', () => {
    /* -------- i18n (不讓失敗打斷地圖) -------- */
    const LANG_KEY = "ugps_lang";
    const supported = ["zhtw","enus"];
    let lang = localStorage.getItem(LANG_KEY) || "zhtw";

    async function loadLang(l){
      try{
        if(!supported.includes(l)) l = "zhtw";
        const res = await fetch(`./locales/${l}.json`, {cache:"no-cache"});
        if(!res.ok) throw new Error(res.statusText);
        const dict = await res.json();
        for (const k of Object.keys(dict)){
          const el = document.getElementById(k);
          if (el) el.textContent = dict[k];
        }
        document.title = dict["app.title"] || "UGPS";
        document.documentElement.setAttribute("lang", l==="zhtw" ? "zh-Hant" : "en");
        document.getElementById("btn-zhtw").classList.toggle("active", l==="zhtw");
        document.getElementById("btn-enus").classList.toggle("active", l==="enus");
        localStorage.setItem(LANG_KEY, l);
        lang = l;
      }catch(e){
        console.warn("loadLang failed:", e);
      }
    }
    document.getElementById("btn-zhtw").onclick = ()=> loadLang("zhtw");
    document.getElementById("btn-enus").onclick = ()=> loadLang("enus");
    loadLang(lang);

    /* -------- 著色 -------- */
    function hexToRgb(h){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:null}
    function rgbToHex({r,g,b}){const to=v=>v.toString(16).padStart(2,"0");return `#${to(r)}${to(g)}${to(b)}`}
    function lerp(a,b,t){return a+(b-a)*t}
    function lerpColor(a,b,t){const ca=hexToRgb(a),cb=hexToRgb(b);return rgbToHex({r:Math.round(lerp(ca.r,cb.r,t)),g:Math.round(lerp(ca.g,cb.g,t)),b:Math.round(lerp(ca.b,cb.b,t))})}
    function scoreColor(t){
      const s=Math.max(0,Math.min(1,t));
      if(s<0.5) return lerpColor("#FFE08A","#FF9F43",s/0.5);
      return lerpColor("#FF9F43","#FF6B6B",(s-0.5)/0.5);
    }

    /* -------- 示例資料 -------- */
    const points = [
      {lat:25.0495, lng:121.5165, score:.85},
      {lat:25.0476, lng:121.5170, score:.65},
      {lat:25.0486, lng:121.5151, score:.55},
      {lat:25.0489, lng:121.5178, score:.75},
      {lat:25.0459, lng:121.5136, score:.40}
    ];

    /* -------- Map -------- */
    let map;
    try{
      map = L.map('map', {zoomControl:true}).setView([25.0479,121.5171], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      // 保險：確保可見大小正確
      setTimeout(()=>map.invalidateSize(), 50);
    }catch(e){
      console.error("Leaflet init failed:", e);
      return; // 沒地圖就不繼續
    }

    /* 點位層 */
    const pointsLayer = L.layerGroup();
    function drawPoints(){
      pointsLayer.clearLayers();
      points.forEach(p=>{
        const color = scoreColor(p.score);
        const icon = L.divIcon({
          className:'',
          html:`<span class="ugps-dot" style="--fill:${color}"></span>`,
          iconSize:[20,20], iconAnchor:[10,10]
        });
        L.marker([p.lat,p.lng], {icon}).addTo(pointsLayer);
      });
    }
    drawPoints();
    pointsLayer.addTo(map);

    /* 熱度圖（暖色、不藍） */
    const HEAT_GRADIENT = {0:'#FFE08A',0.5:'#FF9F43',1:'#FF6B6B'};
    let heatLayer=null;
    function addHeat(){
      if(heatLayer) map.removeLayer(heatLayer);
      const data = points.map(p=>[p.lat,p.lng,p.score]);
      heatLayer = L.heatLayer(data,{radius:42, blur:28, maxZoom:19, gradient:HEAT_GRADIENT}).addTo(map);
    }

    /* 切換 */
    const btnPoints=document.getElementById('btn-points');
    const btnHeat=document.getElementById('btn-heat');

    function showPoints(){
      btnPoints.classList.add('active');
      btnHeat.classList.remove('active');
      if(heatLayer){map.removeLayer(heatLayer);heatLayer=null;}
      if(!map.hasLayer(pointsLayer)) pointsLayer.addTo(map);
    }
    function showHeat(){
      btnHeat.classList.add('active');
      btnPoints.classList.remove('active');
      if(map.hasLayer(pointsLayer)) map.removeLayer(pointsLayer);
      addHeat();
    }
    btnPoints.addEventListener('click', showPoints);
    btnHeat.addEventListener('click', showHeat);

    map.on('zoomend', ()=>{
      if(heatLayer){
        const data = heatLayer._latlngs;
        map.removeLayer(heatLayer);
        heatLayer = L.heatLayer(data,{radius:42, blur:28, maxZoom:19, gradient:HEAT_GRADIENT}).addTo(map);
      }
    });

    /* Top-3（示例） */
    const top3El = document.getElementById('top3');
    function renderTop3(){
      top3El.innerHTML='';
      points.slice(0,3).forEach((p,i)=>{
        const li=document.createElement('li');
        li.textContent=`${i+1}. C${i+19} (${p.lat.toFixed(4)}, ${p.lng.toFixed(4)})`;
        top3El.appendChild(li);
      });
    }
    renderTop3();
  });
  </script>
</body>
</html>

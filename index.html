<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>UGPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
      :root { --card-b:#eee; --muted:#777; }
      body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif; margin:24px; }
      .row { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
      .badge { padding:6px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer; }
      .badge.active { background:#eef; border-color:#99f; }
      .card { border:1px solid var(--card-b); border-radius:12px; padding:16px; }
      small{color:var(--muted)}
      #map { width:100%; height:460px; border-radius:12px; }
      .list-row { display:flex; justify-content:space-between; padding:6px 8px; border:1px solid #eee; border-radius:8px; margin-top:6px }
      select{ padding:6px 8px; border-radius:10px; border:1px solid #ddd; }
      label{ font-size:14px; color:#555; }
    </style>
  </head>
  <body>
    <div class="row">
      <h1 id="app.title">UGPS</h1>
      <div style="margin-left:auto">
        <button id="btn-zhtw" class="badge">zhtw</button>
        <button id="btn-enus" class="badge">enus</button>
      </div>
    </div>

    <div class="row">
      <a id="nav.home" href="#">首頁</a>
      <a id="nav.map" href="#" style="margin-left:12px">地圖</a>
      <a id="nav.export" href="#" style="margin-left:12px">匯出</a>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:4px">
        <b id="legend.title">Legend</b>
        <div style="margin-left:auto; display:flex; gap:12px; align-items:center">
          <label for="region"><span id="filters.region">Region</span>：</label>
          <select id="region">
            <option value="taipei" data-center="25.0478,121.5170" id="region.taipei">Taipei</option>
            <option value="newtaipei" data-center="25.0169,121.4628" id="region.newtaipei">New Taipei</option>
            <option value="taoyuan" data-center="24.9937,121.2969" id="region.taoyuan">Taoyuan</option>
            <option value="taichung" data-center="24.1477,120.6736" id="region.taichung">Taichung</option>
            <option value="tainan" data-center="22.9999,120.2269" id="region.tainan">Tainan</option>
            <option value="kaohsiung" data-center="22.6273,120.3014" id="region.kaohsiung">Kaohsiung</option>
            <option value="gta" data-center="35.6762,139.6503" id="region.gta">Greater Tokyo</option>
          </select>
          <label for="scenario"><span id="filters.scenario">Scenario</span>：</label>
          <select id="scenario">
            <option value="day-clear" id="scenario.day-clear">Day / Clear</option>
            <option value="night-clear" id="scenario.night-clear">Night / Clear</option>
            <option value="day-rain" id="scenario.day-rain">Day / Rain</option>
            <option value="night-rain" id="scenario.night-rain">Night / Rain</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="map.legend.low">Low</small>
        <div style="flex:1;height:8px;background:linear-gradient(90deg,#60a5fa,#f59e0b,#ef4444);border-radius:999px"></div>
        <small id="map.legend.high">High</small>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="row" style="margin:0 0 8px 0">
        <b id="section.map">Map</b>
        <small id="map.subtitle" style="margin-left:8px">UGPS score points</small>
        <div style="margin-left:auto">
          <button id="btn-points" class="badge active"><span id="map.toggle.points">Points</span></button>
          <button id="btn-heat" class="badge"><span id="map.toggle.heat">Heatmap</span></button>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div class="card" id="top.card" style="margin-top:16px">
      <div class="row" style="margin:0 0 8px 0">
        <b id="top.title">Top-3</b>
        <button id="top.exportTask" class="badge" style="margin-left:auto">Export tasks</button>
        <button id="top.export" class="badge">Export</button>
      </div>
      <div id="top.list"><small>Loading…</small></div>
    </div>

    <script>
      const LANG_KEY = "ugps_lang";
      const supported = ["zhtw","enus"];
      let lang = localStorage.getItem(LANG_KEY) || "zhtw";

      async function loadLang(l){
        try{
          if(!supported.includes(l)) l = "zhtw";
          const res = await fetch(`./locales/${l}.json`, { cache:"no-cache" });
          const dict = await res.json();
          Object.keys(dict).forEach(k=>{ const el = document.getElementById(k); if(el) el.textContent = dict[k]; });
          document.title = dict["app.title"] || "UGPS";
          document.documentElement.setAttribute("lang", l === "zhtw" ? "zh-Hant" : "en");
          document.getElementById("btn-zhtw").classList.toggle("active", l==="zhtw");
          document.getElementById("btn-enus").classList.toggle("active", l==="enus");
          localStorage.setItem(LANG_KEY, l); lang = l;
        }catch(e){ console.error(e); }
      }
      document.getElementById("btn-zhtw").onclick = () => loadLang("zhtw");
      document.getElementById("btn-enus").onclick = () => loadLang("enus");

      // Leaflet helpers
      let map, markersLayer, heatLayer=null, __heatSolo=[], __heatOverlay=[], __dataset=[];
      window.__ugpsTop3 = []; window.__ugpsContext = {};

      function radiusForZoom(z){ if(z<=9)return 18; if(z<=12)return 18+(z-9)*8; if(z<=15)return 42+(z-12)*6; if(z<=18)return 60+(z-15)*6; return 80; }
      function makeHeatLayer(dataset){
        const z=map.getZoom(); const r=Math.round(radiusForZoom(z)); const blur=Math.round(r*0.6);
        return L.heatLayer(dataset, {radius:r, blur, maxZoom:19, minOpacity:0.58, gradient: {0:"#60a5fa",0.35:"#93c5fd",0.55:"#f59e0b",0.75:"#f97316",1:"#ef4444"}});
      }
      function colorByScore01(x){ const clrs=[[220,91,60],[38,90,55],[0,85,58]]; const p=Math.max(0,Math.min(1,x)); const t=p<0.5?p*2:(p-0.5)*2; const a=p<0.5?clrs[0]:clrs[1]; const b=p<0.5?clrs[1]:clrs[2]; const h=a[0]+(b[0]-a[0])*t; const s=a[1]+(b[1]-a[1])*t; const l=a[2]+(b[2]-a[2])*t; return `hsl(${h}deg ${s}% ${l}%)`; }

      function ensureMap(){
        if(map) return;
        map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
        map.createPane("points"); map.getPane("points").style.zIndex = 650; markersLayer = L.layerGroup().addTo(map); map.setView([25.0478,121.5170], 13);
        map.on("zoomend", ()=>{ if(!heatLayer) return; map.removeLayer(heatLayer); heatLayer = makeHeatLayer(__heatSolo).addTo(map); });
      }
      function showPoints(){ document.getElementById("btn-points").classList.add("active"); document.getElementById("btn-heat").classList.remove("active"); if(markersLayer && !map.hasLayer(markersLayer)) markersLayer.addTo(map); if(heatLayer && map.hasLayer(heatLayer)) map.removeLayer(heatLayer); }
      function showHeat(){ document.getElementById("btn-heat").classList.add("active"); document.getElementById("btn-points").classList.remove("active"); if(markersLayer && map.hasLayer(markersLayer)) map.removeLayer(markersLayer); if(heatLayer && map.hasLayer(heatLayer)) map.removeLayer(heatLayer); heatLayer = makeHeatLayer(__heatSolo).addTo(map); }
      document.getElementById("btn-points").onclick = showPoints; document.getElementById("btn-heat").onclick = showHeat;

      async function loadData(region, scenario){
        ensureMap();
        const path = `./data/${region}/${scenario}.json`;
        let data = null;
        try{
          const res = await fetch(path, { cache: "no-cache" });
          if(!res.ok) throw new Error("fetch failed");
          data = await res.json();
        }catch(e){
          const fallback = "./data/ugps.json";
          const r2 = await fetch(fallback); data = await r2.json();
        }
        window.__ugpsContext = data.context || {};
        const pts = Array.isArray(data.grid) ? data.grid : [];
        __dataset = pts;
        const top = [...pts].sort((a,b)=>b.score-a.score).slice(0,3);
        window.__ugpsTop3 = top;
        const toRow = (c,i)=>`<div class="list-row"><span>${i+1}. ${c.id} (${c.lat.toFixed(4)}, ${c.lon.toFixed(4)})</span><b>${(c.score*100).toFixed(0)}</b></div>`;
        document.getElementById("top.list").innerHTML = top.length ? top.map(toRow).join("") : `<small id="map.nodata">No data</small>`;

        markersLayer.clearLayers();
        const bounds = [];
        const coreR=8, haloR=coreR+3;
        pts.forEach(p=>{ const ll=[p.lat,p.lon]; bounds.push(ll);
          L.circleMarker(ll, {pane:"points", radius:haloR, color:"#fff", weight:5, fill:false, opacity:0.9}).addTo(markersLayer);
          L.circleMarker(ll, {pane:"points", radius:coreR, color:"#111", weight:1.6, fillColor:colorByScore01(p.score), fillOpacity:0.95})
            .bindPopup(`<b>${p.id}</b><br/>${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}<br/>Score: ${(p.score*100).toFixed(0)}`).addTo(markersLayer);
        });
        if(bounds.length) map.fitBounds(bounds, {padding:[20,20]});
        // heat weights
        const sorted = pts.map(p=>p.score).sort((a,b)=>a-b);
        const q=t=>sorted.length?sorted[Math.floor((sorted.length-1)*t)]:0;
        const p10=q(0.10), p90=q(0.90), rng=Math.max(1e-6, p90-p10);
        __heatSolo = pts.map(p=>{ let s=(p.score-p10)/rng; s=Math.max(0,Math.min(1,s)); const gamma=0.55; let w=Math.pow(s,gamma); return [p.lat,p.lon,0.12+0.88*w]; });
        showPoints();
      }

      function currentSel(){ return { region: document.getElementById("region").value, scenario: document.getElementById("scenario").value }; }
      document.getElementById("region").onchange = ()=>{ const {region,scenario} = currentSel(); loadData(region, scenario); };
      document.getElementById("scenario").onchange = ()=>{ const {region,scenario} = currentSel(); loadData(region, scenario); };

      function toCSV(rows){ const header=["rank","id","lat","lon","score_0to100"]; const lines=[header.join(",")].concat(rows.map((c,i)=>[i+1,c.id,c.lat,c.lon,Math.round(c.score*100)].join(","))); return lines.join("\r\n"); }
      function downloadCSV(filename,text){ const BOM="\uFEFF"; const blob=new Blob([BOM+text],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
      function toTaskCSV(rows, context){ const header=["datetime_window","cell_id","lat","lon","score_0to100","scenario","note"]; const dt=new Date().toISOString().slice(0,16).replace("T"," "); const scen=(context&&context.scenario)||"unknown"; const lines=[header.join(",")].concat(rows.map((c,i)=>[`${dt} ~ +2h`,c.id,c.lat,c.lon,Math.round(c.score*100),scen,`Rank ${i+1}`].join(","))); return lines.join("\r\n"); }
      document.getElementById("top.export").onclick = ()=>{ const rows=window.__ugpsTop3||[]; if(!rows.length)return alert("No data"); const {region,scenario}=currentSel(); downloadCSV(`ugps-top3-${region}-${scenario}-${(new Date()).toISOString().slice(0,10)}.csv`, toCSV(rows)); };
      document.getElementById("top.exportTask").onclick = ()=>{ const rows=window.__ugpsTop3||[]; if(!rows.length)return alert("No data"); const {region,scenario}=currentSel(); downloadCSV(`ugps-outreach-${region}-${scenario}-${(new Date()).toISOString().slice(0,10)}.csv`, toTaskCSV(rows, window.__ugpsContext||{})); };

      // init
      loadLang(lang);
      const initRegion = "taipei", initScenario = "day-clear"; loadData(initRegion, initScenario);
    </script>

    <div style="position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 12px;font-size:12px;color:#555">
      <b id="meta.dataSource">資料來源</b>：OSM / Gov Open Data　|　<b id="meta.version">版本</b>：v0.0.2
    </div>
  </body>
</html>
